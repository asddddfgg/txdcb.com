<%*
// ==========================================
// ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨ - çœŸæ­£çš„ä¸€ä¸ªæ¨¡æ¿æœæ‰€æœ‰æ ‡ç­¾
// åªéœ€ä¿®æ”¹ SEARCH_TAG å˜é‡å³å¯
// ==========================================

// ğŸ¯ ã€åªéœ€ä¿®æ”¹è¿™é‡Œã€‘é…ç½®ä½ è¦æœç´¢çš„æ ‡ç­¾
const SEARCH_TAG = "#ä¸ªäºº";  // æ”¹æˆ #å­¦ä¹ ã€#æˆé•¿ã€#æ€è€ƒ ç­‰ä»»ä½•æ ‡ç­¾

// ğŸ¨ ã€å¯é€‰ä¿®æ”¹ã€‘è¾“å‡ºæ–‡ä»¶å’Œæ ‡é¢˜
const OUTPUT_FILE = `${SEARCH_TAG.replace('#', '')}å†…å®¹æ”¶é›†.md`; // è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶å
const COLLECTION_TITLE = `${SEARCH_TAG.replace('#', '')}å†…å®¹æ”¶é›†`; // è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜

// ğŸš« è‡ªåŠ¨æ’é™¤çš„æ–‡ä»¶ï¼ˆä¸ç”¨æ”¹ï¼‰
const EXCLUDE_FILES = [
    "ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨.md",
    OUTPUT_FILE  // è‡ªåŠ¨æ’é™¤è¾“å‡ºæ–‡ä»¶è‡ªèº«
];

// ğŸ•’ è®°å½•å¼€å§‹æ—¶é—´
const startTime = new Date();

// ğŸ” æœç´¢å…¨ç«™åŒ…å«æŒ‡å®šæ ‡ç­¾çš„æ–‡ä»¶
const allFiles = app.vault.getMarkdownFiles()
    .filter(file => !EXCLUDE_FILES.includes(file.name));

let foundSentences = new Map();
let totalFilesScanned = 0;
let filesWithTag = 0;

// ğŸ“– éå†æ‰€æœ‰æ–‡ä»¶ï¼Œæœç´¢ç›¸å…³å¥å­
for (const file of allFiles) {
    totalFilesScanned++;
    const content = await app.vault.read(file);
    const lines = content.split('\n');
    
    let fileHasTagContent = false;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // åŸºç¡€è¿‡æ»¤
        if (!line || line.length < 10) continue;
        if (line.startsWith('#') || line.startsWith('---')) continue;
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡æ ‡ç­¾
        if (line.includes(SEARCH_TAG)) {
            // è·³è¿‡ç»Ÿè®¡ä¿¡æ¯å’Œä»£ç è¡Œ
            if (line.includes('æ‰«ææ–‡ä»¶') || line.includes('æœ‰æ•ˆæ–‡ä»¶') || line.includes('æ”¶é›†å†…å®¹') || 
                line.includes('è¿è¡Œè€—æ—¶') || line.includes('const ') || line.includes('let ') ||
                line.includes('await ') || line.includes('tR +=') || line.includes('collectionContent') ||
                line.includes('SEARCH_TAG') || line.includes('OUTPUT_FILE') || line.includes('EXCLUDE_FILES')) {
                continue;
            }
            
            // æ¸…ç†å¥å­æ ¼å¼
            let cleanSentence = line
                .replace(/^[>-]\s*/, '')
                .replace(/\s+/g, ' ')
                .replace(/`/g, '')
                .trim();
            
            // ç¡®ä¿æ˜¯çœŸæ­£çš„æ–‡æœ¬å†…å®¹
            if (cleanSentence.length >= 10 && 
                !cleanSentence.startsWith('//') &&
                !cleanSentence.includes('æ‰«ææ–‡ä»¶') &&
                !cleanSentence.includes('æœ‰æ•ˆæ–‡ä»¶') &&
                !cleanSentence.includes('æ”¶é›†å†…å®¹')) {
                
                if (!foundSentences.has(cleanSentence)) {
                    foundSentences.set(cleanSentence, {
                        sourceFile: file.basename,
                        sourcePath: file.path
                    });
                    fileHasTagContent = true;
                }
            }
        }
    }
    
    if (fileHasTagContent) {
        filesWithTag++;
    }
}

// ğŸ“Š ç”Ÿæˆæ”¶é›†å†…å®¹
let collectionContent = `# ${COLLECTION_TITLE}\n\n`;

// ç»Ÿè®¡ä¿¡æ¯
collectionContent += `æ”¶é›†æ—¶é—´ï¼š${new Date().toLocaleString()}  |  æ‰«ææ–‡ä»¶ï¼š${totalFilesScanned}  |  åŒ…å«æ ‡ç­¾ï¼š${filesWithTag}  |  æ”¶é›†å†…å®¹ï¼š${foundSentences.size}\n\n`;

collectionContent += `---\n\n`;

if (foundSentences.size === 0) {
    collectionContent += `> è¿˜æ²¡æœ‰æ‰¾åˆ°åŒ…å« ${SEARCH_TAG} æ ‡ç­¾çš„å†…å®¹ã€‚\n`;
} else {
    // å†…å®¹åˆ—è¡¨
    const sortedSentences = Array.from(foundSentences.entries())
        .sort(([sentenceA], [sentenceB]) => sentenceA.localeCompare(sentenceB));
    
    for (const [sentence, info] of sortedSentences) {
        collectionContent += `${sentence}\n\n`;
        collectionContent += `â†³ æ¥æºï¼š[[${info.sourceFile}]]\n\n`;
        collectionContent += `---\n\n`;
    }
}

// æ›´æ–°è¯´æ˜
collectionContent += `*è‡ªåŠ¨ç”Ÿæˆ Â· æœ€åæ›´æ–°ï¼š${new Date().toLocaleString()} Â· æœç´¢æ ‡ç­¾ï¼š${SEARCH_TAG}*`;

// ğŸ’¾ ä¿å­˜åˆ°æ–‡ä»¶
const targetFile = app.vault.getAbstractFileByPath(OUTPUT_FILE);
if (targetFile) {
    await app.vault.modify(targetFile, collectionContent);
} else {
    await app.vault.create(OUTPUT_FILE, collectionContent);
}

// ğŸŠ ç»“æœæ˜¾ç¤º
tR += `## ${SEARCH_TAG} æœç´¢å®Œæˆ\n\n`;
tR += `- æ‰«ææ–‡ä»¶ï¼š${totalFilesScanned}\n`;
tR += `- æœ‰æ•ˆæ–‡ä»¶ï¼š${filesWithTag}\n`;
tR += `- æ”¶é›†å†…å®¹ï¼š${foundSentences.size}\n`;
tR += `- è¿è¡Œè€—æ—¶ï¼š${(new Date() - startTime) / 1000}ç§’\n\n`;

if (foundSentences.size > 0) {
    tR += `**é¢„è§ˆï¼š**\n\n`;
    const previewSentences = Array.from(foundSentences.entries()).slice(0, 3);
    previewSentences.forEach(([sentence], index) => {
        if (!sentence.includes('æ‰«ææ–‡ä»¶') && !sentence.includes('æœ‰æ•ˆæ–‡ä»¶')) {
            tR += `${sentence}\n\n`;
        }
    });
}

tR += `> ğŸ’¡ æç¤ºï¼šè¦æœç´¢å…¶ä»–æ ‡ç­¾ï¼Œåªéœ€ä¿®æ”¹æ¨¡æ¿å¼€å¤´çš„ SEARCH_TAG å˜é‡`;
%>