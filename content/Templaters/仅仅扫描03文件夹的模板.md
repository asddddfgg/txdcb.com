<%*
// ==========================================
// ğŸŒŸ Obsidian SEO & æ ‡ç­¾é‡‘å¥ç”Ÿæˆå™¨ï¼ˆå«ç™¾åº¦ç»Ÿè®¡ï¼Œç½‘é¡µè·¯å¾„ç‰ˆ for Quartzï¼‰
// ==========================================

if(typeof window._tagCollectorRunning!=='undefined'){ tR+="# âš ï¸ ä¸Šæ¬¡è¿è¡Œæœªå®Œæˆ"; return; }
window._tagCollectorRunning=true;
const cleanup=()=>setTimeout(()=>delete window._tagCollectorRunning,1000);

try {
  const TARGET_FOLDER="02 Notes"; // è¾“å‡ºæ–‡ä»¶å¤¹
  const SCAN_FOLDER="03 Archive"; // åªæ‰«æè¿™ä¸ªæ–‡ä»¶å¤¹
  const HEADER_SUFFIX="çš„åè¨€é‡‘å¥";
  const EXCLUDE_FILES=new Set(["ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨.md","å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md","tR.md"]);

  const COLORS={
    "èŒåœº":"#ff6b6b","å“²å­¦":"#5f27cd","ç¤¾ä¼šè§‚å¯Ÿ":"#00b894","ä¸ªäººæˆé•¿":"#fdcb6e",
    "çŠ€åˆ©åæ§½":"#fd79a8","AI":"#3498db","æ€è€ƒ":"#00cec9","ç«äº‰å“²å­¦":"#8e44ad",
    "å¿ƒæ€è°ƒæ•´":"#16a085","æˆåŠŸå­¦":"#e17055","æƒåŠ›ç»“æ„":"#c0392b","äººæ€§":"#27ae60"
  };
  const DEFAULT_COLOR="#667eea";
  const getColor=(tag)=>COLORS[tag]||DEFAULT_COLOR;

  const currentFile = app.workspace.activeLeaf?.view?.file?.name;
  if(currentFile) EXCLUDE_FILES.add(currentFile);

  // åªæ‰«æ SCAN_FOLDER ä¸‹çš„ Markdown æ–‡ä»¶
  const allFiles = app.vault.getMarkdownFiles().filter(f=>{
    if(EXCLUDE_FILES.has(f.name)) return false;
    if(!f.path.startsWith(`${SCAN_FOLDER}/`)) return false;
    if(f.name.includes(HEADER_SUFFIX)) return false;
    return true;
  });

  const allTags = new Set();
  const tagContentMap = new Map();

  await Promise.all(allFiles.map(async file => {
    const content = await app.vault.read(file);
    content.split('\n').forEach(rawLine => {
      const line = rawLine.trim();
      if(!line || line.length < 10 || line.startsWith('```') || line.startsWith('---')) return;
      const tagMatches = line.match(/#[\w\u4e00-\u9fa5\-\/]+/g);
      if(!tagMatches) return;
      const cleanSentence = line.replace(/^[>-]\s*/,'').replace(/#[\w\u4e00-\u9fa5\-\/]+/g,'').replace(/\s+/g,' ').trim();
      if(cleanSentence.length < 10) return;
      const validTags = tagMatches.filter(t => t.length > 1);
      if(validTags.length === 0) return;

      validTags.forEach(tag=>{
        allTags.add(tag);
        if(!tagContentMap.has(tag)) tagContentMap.set(tag, []);
        const arr = tagContentMap.get(tag);
        if(!arr.some(i => i.sentence===cleanSentence && JSON.stringify(i.allTags)===JSON.stringify(validTags)))
          arr.push({sentence: cleanSentence, sourceFile: file.basename, allTags: [...validTags]});
      });
    });
  }));

  if(!app.vault.getAbstractFileByPath(TARGET_FOLDER)) await app.vault.createFolder(TARGET_FOLDER);

  const WEB_ROOT = 'https://txdcb.com/02-Notes/';

  for(const tag of Array.from(allTags).sort()){
    const contents = tagContentMap.get(tag) || [];
    if(contents.length === 0) continue;

    const tagName = tag.replace('#','');
    const safeFileName = tagName.replace(/[\\\/:*?"<>|]/g,''); 
    const filePath = `${TARGET_FOLDER}/${safeFileName}${HEADER_SUFFIX}.md`;
    const existingFile = app.vault.getAbstractFileByPath(filePath);
    const color = getColor(tagName);

    // âœ… SEO Meta åŠ¨æ€ç”Ÿæˆ
    const metaTitle = `å…³äºã€Œ${tagName}ã€çš„åè¨€é‡‘å¥ - TXDCB`;
    const metaDesc = `æ”¶å½• ${contents.length} æ¡å…³äº${tagName}çš„ç²¾é€‰é‡‘å¥ï¼Œè¦†ç›–èŒåœºã€å“²å­¦ã€å¿ƒæ€è°ƒæ•´ç­‰é¢†åŸŸï¼ŒåŠ©åŠ›ä¸ªäººæˆé•¿ä¸æ€è€ƒã€‚`;
    const metaKeywords = [tagName,...contents.flatMap(i=>i.allTags.map(t=>t.replace('#','')))].join(',');

    let html = `
<head>
  <title>${metaTitle}</title>
  <meta name="description" content="${metaDesc}">
  <meta name="keywords" content="${metaKeywords}">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "${metaTitle}",
    "itemListElement": [
      ${contents.map((i,k)=>`{
        "@type":"ListItem",
        "position":${k+1},
        "name":"${i.sentence}",
        "url":"${WEB_ROOT}${encodeURIComponent(safeFileName)}.html"
      }`).join(',')}
    ]
  }
  </script>

  <!-- ç™¾åº¦ç»Ÿè®¡ -->
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?ä½ çš„ç™¾åº¦ç»Ÿè®¡ID";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
</head>
<body>
<div class="tag-header" style="background:${color}">
  <h1>å…³äºã€Œ${tagName}ã€çš„åè¨€é‡‘å¥</h1>
  <p>æ”¶å½• ${contents.length} æ¡å†…å®¹</p>
</div>
<div class="tag-content-wrapper"><div class="tag-content">`;

    contents.sort((a,b)=>a.sentence.localeCompare(b.sentence));

    for(const item of contents){
      const tagLinks = item.allTags.map(t=>{
        const tn = t.replace('#','');
        const fileName = encodeURIComponent(`${tn}${HEADER_SUFFIX}.html`);
        return `<a href="${WEB_ROOT}${fileName}" style="--card-color:${getColor(tn)}">${tn}</a>`;
      }).join('');
      html += `<article class="tag-card" style="--card-color:${getColor(item.allTags[0]?.replace('#','')||tagName)}">
                 <div class="sentence">${item.sentence}</div>
                 <div class="tag-links">${tagLinks}</div>
               </article>`;
    }

    html += `</div><div class="tag-footer"><p>ğŸ• ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}</p></div></div></body>`;

    if(existingFile) await app.vault.modify(existingFile, html);
    else await app.vault.create(filePath, html);
  }

  tR += "# âœ… æ ‡ç­¾é‡‘å¥æ”¶é›†å®Œæˆï¼ˆå«ç™¾åº¦ç»Ÿè®¡ï¼‰";

}catch(e){ console.error(e); tR += `# âŒ å‡ºé”™: ${e.message}`; }
finally{ cleanup(); }
%>