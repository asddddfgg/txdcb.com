<%*
// ==========================================
// ğŸŒŸ Obsidian æ ‡ç­¾é‡‘å¥ç”Ÿæˆå™¨ï¼ˆå¤šå±‚ & åˆ†é¡µ & ç›®å½•ç‰ˆ for Quartzï¼‰
// ==========================================

if(typeof window._tagCollectorRunning!=='undefined'){ tR+="# âš ï¸ ä¸Šæ¬¡è¿è¡Œæœªå®Œæˆ"; return; }
window._tagCollectorRunning=true;
const cleanup=()=>setTimeout(()=>delete window._tagCollectorRunning,1000);

try {
  const TARGET_FOLDER="02 Notes";
  const HEADER_SUFFIX="çš„åè¨€é‡‘å¥";
  const EXCLUDE_FOLDERS=["Templaters","04 Private ç§äººæ–‡ä»¶å¤¹","templates"];
  const EXCLUDE_FILES=new Set(["ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨.md","å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md","tR.md"]);

  const COLORS={
    "èŒåœº":"#ff6b6b","å“²å­¦":"#5f27cd","ç¤¾ä¼šè§‚å¯Ÿ":"#00b894","ä¸ªäººæˆé•¿":"#fdcb6e",
    "çŠ€åˆ©åæ§½":"#fd79a8","AI":"#3498db","æ€è€ƒ":"#00cec9","ç«äº‰å“²å­¦":"#8e44ad",
    "å¿ƒæ€è°ƒæ•´":"#16a085","æˆåŠŸå­¦":"#e17055","æƒåŠ›ç»“æ„":"#c0392b","äººæ€§":"#27ae60"
  };
  const DEFAULT_COLOR="#667eea";
  const getColor=(tag)=>COLORS[tag]||DEFAULT_COLOR;

  const currentFile = app.workspace.activeLeaf?.view?.file?.name;
  if(currentFile) EXCLUDE_FILES.add(currentFile);

  const allFiles = app.vault.getMarkdownFiles().filter(f=>{
    if(EXCLUDE_FILES.has(f.name)) return false;
    if(f.path.includes(TARGET_FOLDER) && f.name.includes(HEADER_SUFFIX)) return false;
    if(EXCLUDE_FOLDERS.some(folder=>f.path.includes(folder))) return false;
    return true;
  });

  const tagContentMap = new Map(); // { 'ä¸»æ ‡ç­¾/å­æ ‡ç­¾' => [{sentence, sourceFile, allTags}] }
  const allTagsSet = new Set();

  // è¯»å–æ–‡ä»¶
  await Promise.all(allFiles.map(async file => {
    const content = await app.vault.read(file);
    content.split('\n').forEach(rawLine => {
      const line = rawLine.trim();
      if(!line || line.length < 10 || line.startsWith('```') || line.startsWith('---')) return;
      const tagMatches = line.match(/#[\w\u4e00-\u9fa5\-\/]+/g);
      if(!tagMatches) return;
      const cleanSentence = line.replace(/^[>-]\s*/,'').replace(/#[\w\u4e00-\u9fa5\-\/]+/g,'').replace(/\s+/g,' ').trim();
      if(cleanSentence.length < 10) return;
      const validTags = tagMatches.filter(t=>t.length>1);
      if(validTags.length === 0) return;

      validTags.forEach(tag=>{
        allTagsSet.add(tag);
        if(!tagContentMap.has(tag)) tagContentMap.set(tag, []);
        const arr = tagContentMap.get(tag);
        if(!arr.some(i => i.sentence===cleanSentence && JSON.stringify(i.allTags)===JSON.stringify(validTags)))
          arr.push({sentence: cleanSentence, sourceFile: file.basename, allTags: [...validTags]});
      });
    });
  }));

  // åˆ›å»ºæ–‡ä»¶å¤¹
  if(!app.vault.getAbstractFileByPath(TARGET_FOLDER)) await app.vault.createFolder(TARGET_FOLDER);

  const WEB_ROOT = 'https://txdcb.com/02-Notes/';
  const PAGE_SIZE = 20; // æ¯é¡µæ¡ç›®æ•°

  const indexEntries = []; // æ€»ç›®å½•ä¿¡æ¯ [{tagName, count, fileLinks}]

  // ç”Ÿæˆæ¯ä¸ªæ ‡ç­¾é¡µé¢
  for(const tag of Array.from(allTagsSet).sort()){
    const contents = tagContentMap.get(tag) || [];
    if(contents.length === 0) continue;

    const tagName = tag.replace('#','');
    const safeFileName = tagName.replace(/[\\\/:*?"<>|]/g,'');
    const totalPages = Math.ceil(contents.length / PAGE_SIZE);

    for(let page=0; page<totalPages; page++){
      const pageContents = contents.slice(page*PAGE_SIZE, (page+1)*PAGE_SIZE);
      const filePath = totalPages>1 ? `${TARGET_FOLDER}/${safeFileName}_page${page+1}.md` : `${TARGET_FOLDER}/${safeFileName}${HEADER_SUFFIX}.md`;
      const existingFile = app.vault.getAbstractFileByPath(filePath);

      let html = `<div class="tag-header" style="background:${getColor(tagName)}">
                    <h1>å…³äºã€Œ${tagName}ã€çš„åè¨€é‡‘å¥ ${totalPages>1?`(ç¬¬ ${page+1} é¡µ)`:""}</h1>
                    <p>æ”¶å½• ${contents.length} æ¡å†…å®¹</p>
                  </div>
                  <div class="tag-content-wrapper"><div class="tag-content">`;

      pageContents.sort((a,b)=>a.sentence.localeCompare(b.sentence));

      for(const item of pageContents){
        const tagLinks = item.allTags.map(t=>{
          const tn = t.replace('#','');
          const fileName = encodeURIComponent(`${tn}${HEADER_SUFFIX}.html`);
          return `<a href="${WEB_ROOT}${fileName}" style="--card-color:${getColor(tn)}">${tn}</a>`;
        }).join('');
        html += `<article class="tag-card" style="--card-color:${getColor(item.allTags[0]?.replace('#','')||tagName)}">
                   <div class="sentence">${item.sentence}</div>
                   <div class="tag-links">${tagLinks}</div>
                 </article>`;
      }

      // åˆ†é¡µå¯¼èˆª
      if(totalPages > 1){
        html += `<div class="pagination">`;
        if(page>0) html += `<a href="${WEB_ROOT}${safeFileName}_page${page}.html">&laquo; ä¸Šä¸€é¡µ</a>`;
        if(page<totalPages-1) html += `<a href="${WEB_ROOT}${safeFileName}_page${page+2}.html">ä¸‹ä¸€é¡µ &raquo;</a>`;
        html += `</div>`;
      }

      html += `</div><div class="tag-footer"><p>ğŸ• ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}</p></div></div>`;

      if(existingFile) await app.vault.modify(existingFile, html);
      else await app.vault.create(filePath, html);
    }

    indexEntries.push({tagName, count: contents.length, link: encodeURIComponent(`${safeFileName}${HEADER_SUFFIX}.html`)});
  }

  // ç”Ÿæˆæ€»ç›®å½•é¡µ
  const indexFilePath = `${TARGET_FOLDER}/index.md`;
  let indexHtml = `<div class="tag-index"><h1>æ ‡ç­¾æ€»ç›®å½•</h1><ul>`;
  indexEntries.sort((a,b)=>a.tagName.localeCompare(b.tagName)).forEach(entry=>{
    indexHtml += `<li><a href="${WEB_ROOT}${entry.link}" style="--card-color:${getColor(entry.tagName)}">${entry.tagName}</a>ï¼ˆæ”¶å½• ${entry.count} æ¡ï¼‰</li>`;
  });
  indexHtml += `</ul></div>`;

  const existingIndexFile = app.vault.getAbstractFileByPath(indexFilePath);
  if(existingIndexFile) await app.vault.modify(existingIndexFile, indexHtml);
  else await app.vault.create(indexFilePath, indexHtml);

  tR += "# âœ… æ ‡ç­¾é‡‘å¥æ”¶é›†å®Œæˆï¼ˆå¤šå±‚ & åˆ†é¡µ & æ€»ç›®å½•ç‰ˆï¼‰";

}catch(e){ console.error(e); tR += `# âŒ å‡ºé”™: ${e.message}`; }
finally{ cleanup(); }
%>
