<%*
// ==========================================
// å…¨ç«™æ ‡ç­¾è‡ªåŠ¨æ”¶é›†å™¨ - ä¸€é”®ç”Ÿæˆæ‰€æœ‰æ ‡ç­¾å†…å®¹
// æœ€ç»ˆç‰ˆï¼šä¿®å¤æ‰€æœ‰é—®é¢˜
// ==========================================

// ğŸ¨ é…ç½®åŒºåŸŸï¼ˆè¯·ç¡®è®¤ä¿®æ”¹ï¼‰
const TARGET_FOLDER = "02 Notes";  // ç›®æ ‡æ–‡ä»¶å¤¹åç§°
const COLLECTION_TITLE_PREFIX = "æ ‡ç­¾æ”¶é›†ï¼š";  // æ ‡é¢˜å‰ç¼€

// ğŸš« æ’é™¤çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆè‡ªåŠ¨æ’é™¤æ‰€æœ‰æ”¶é›†æ–‡ä»¶ï¼‰
const EXCLUDE_FILES = [
    "æ›´æ–°èŒåœºé‡‘å¥æ”¶é›†.md",
    "æ›´æ–°èŒåœºé‡‘å¥æ”¶é›†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰.md",
    "æ›´æ–°èŒåœºé‡‘å¥æ”¶é›†ï¼ˆä¼˜é›…ç‰ˆï¼‰.md",
    "æ›´æ–°èŒåœºé‡‘å¥æ”¶é›†ï¼ˆä¿®å¤ç‰ˆï¼‰.md",
    "ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨.md",
    "èŒåœºé‡‘å¥æ”¶é›†.md",
    "å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md"
];

// è·å–å½“å‰æ¨¡æ¿æ–‡ä»¶åï¼ˆç”¨äºæ’é™¤è‡ªèº«ï¼‰
const currentTemplateName = app.workspace.activeLeaf?.view?.file?.name || "æœªçŸ¥æ¨¡æ¿";

// å¦‚æœå½“å‰æ¨¡æ¿ä¸åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œæ·»åŠ å®ƒ
if (!EXCLUDE_FILES.includes(currentTemplateName)) {
    EXCLUDE_FILES.push(currentTemplateName);
}

// ğŸ•’ è®°å½•å¼€å§‹æ—¶é—´
const startTime = new Date();

// ğŸ” ç¬¬ä¸€æ­¥ï¼šæ‰«æå…¨ç«™æ‰€æœ‰æ ‡ç­¾ï¼ˆæ’é™¤ç›®æ ‡æ–‡ä»¶å¤¹ä¸­çš„æ”¶é›†æ–‡ä»¶ï¼‰
console.log("å¼€å§‹æ‰«æå…¨ç«™æ ‡ç­¾...");

// è·å–æ‰€æœ‰æ–‡ä»¶ï¼Œæ’é™¤ç›®æ ‡æ–‡ä»¶å¤¹ä¸­çš„æ”¶é›†æ–‡ä»¶å’ŒæŒ‡å®šæ’é™¤æ–‡ä»¶
const allFiles = app.vault.getMarkdownFiles()
    .filter(file => {
        // æ’é™¤æŒ‡å®šæ–‡ä»¶
        if (EXCLUDE_FILES.includes(file.name)) {
            return false;
        }
        
        // æ’é™¤æ‰€æœ‰åŒ…å«"å†…å®¹æ”¶é›†.md"çš„æ–‡ä»¶ï¼ˆé¿å…æŸ¥è¯¢å·²ç”Ÿæˆçš„æ”¶é›†æ–‡ä»¶ï¼‰
        if (file.name.includes("å†…å®¹æ”¶é›†.md") && file.path.includes(TARGET_FOLDER)) {
            return false;
        }
        
        // æ’é™¤æ€»è§ˆæ–‡ä»¶
        if (file.name === "å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md" && file.path.includes(TARGET_FOLDER)) {
            return false;
        }
        
        return true;
    });

let allTags = new Set();
let tagFileMap = new Map(); // æ ‡ç­¾ -> æ–‡ä»¶æ˜ å°„
let totalFilesScanned = 0;
let tagSentencesMap = new Map(); // æ ‡ç­¾ -> å¥å­é›†åˆ

// ğŸ“– æ‰«ææ‰€æœ‰æ–‡ä»¶ï¼Œæå–æ ‡ç­¾
for (const file of allFiles) {
    totalFilesScanned++;
    const content = await app.vault.read(file);
    const lines = content.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // åŸºç¡€è¿‡æ»¤
        if (!line || line.length < 10) continue;
        if (line.startsWith('#') || line.startsWith('---')) continue;
        
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ‰€æœ‰æ ‡ç­¾ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        const tagMatches = line.match(/#[^\s#<>[\]{}()ï¼Œ,ã€‚ï¼!ï¼Ÿ?;ï¼›:ï¼š'"`~@#$%^&*+=|\\/]+/g);
        
        if (tagMatches) {
            tagMatches.forEach(tag => {
                // æ¸…ç†æ ‡ç­¾æ ¼å¼
                const cleanTag = tag.trim();
                
                // è¿›ä¸€æ­¥è¿‡æ»¤æ— æ•ˆæ ‡ç­¾
                if (cleanTag.length > 2 && 
                    !cleanTag.includes('æ‰«ææ–‡ä»¶') && 
                    !cleanTag.includes('æœ‰æ•ˆæ–‡ä»¶') && 
                    !cleanTag.includes('æ”¶é›†å†…å®¹') &&
                    !cleanTag.includes('const ') &&
                    !cleanTag.includes('let ') &&
                    !cleanTag.includes('await ') &&
                    !cleanTag.includes('tR +=') &&
                    !cleanTag.includes('function') &&
                    !cleanTag.includes('async ') &&
                    !cleanTag.startsWith('# ') &&
                    !cleanTag.startsWith('#\n') &&
                    !cleanTag.match(/^#[0-9]/) && // æ’é™¤ #1, #2 ç­‰ç¼–å·
                    !cleanTag.includes('SEARCH_TAG') &&
                    !cleanTag.includes('OUTPUT_FILE')) {
                    
                    allTags.add(cleanTag);
                    
                    // è®°å½•æ ‡ç­¾æ‰€åœ¨çš„æ–‡ä»¶
                    if (!tagFileMap.has(cleanTag)) {
                        tagFileMap.set(cleanTag, new Set());
                    }
                    tagFileMap.get(cleanTag).add(file.basename);
                    
                    // æå–åŒ…å«æ ‡ç­¾çš„å¥å­
                    if (!tagSentencesMap.has(cleanTag)) {
                        tagSentencesMap.set(cleanTag, new Map());
                    }
                    
                    // æ¸…ç†å¥å­æ ¼å¼
                    let cleanSentence = line
                        .replace(/^[>-]\s*/, '')
                        .replace(/\s+/g, ' ')
                        .replace(/`/g, '')
                        .trim();
                    
                    // ç¡®ä¿æ˜¯çœŸæ­£çš„æ–‡æœ¬å†…å®¹
                    if (cleanSentence.length >= 10 && 
                        !cleanSentence.startsWith('//') &&
                        !cleanSentence.includes('æ‰«ææ–‡ä»¶') &&
                        !cleanSentence.includes('æœ‰æ•ˆæ–‡ä»¶') &&
                        !cleanSentence.includes('æ”¶é›†å†…å®¹') &&
                        !cleanSentence.includes('const ') &&
                        !cleanSentence.includes('let ') &&
                        !cleanSentence.includes('await ') &&
                        !cleanSentence.includes('tR +=') &&
                        !cleanSentence.includes('collectionContent') &&
                        !cleanSentence.includes('SEARCH_TAG') &&
                        !cleanSentence.includes('OUTPUT_FILE') &&
                        !cleanSentence.includes('EXCLUDE_FILES') &&
                        !cleanSentence.includes('totalFilesScanned')) {
                        
                        // å»é‡å­˜å‚¨
                        if (!tagSentencesMap.get(cleanTag).has(cleanSentence)) {
                            tagSentencesMap.get(cleanTag).set(cleanSentence, {
                                sourceFile: file.basename,
                                sourcePath: file.path
                            });
                        }
                    }
                }
            });
        }
    }
}

// ğŸ“Š ç¬¬äºŒæ­¥ï¼šå‡†å¤‡ç”Ÿæˆæ”¶é›†æ–‡ä»¶
console.log(`å‘ç° ${allTags.size} ä¸ªæ ‡ç­¾ï¼Œå¼€å§‹ç”Ÿæˆæ”¶é›†æ–‡ä»¶åˆ° ${TARGET_FOLDER} æ–‡ä»¶å¤¹...`);

let createdFiles = 0;
let updatedFiles = 0;
let failedFiles = 0;
const allTagsArray = Array.from(allTags).sort();

// è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
function sanitizeFileName(filename) {
    return filename.replace(/[\\/*"<>:|?]/g, '-');
}

// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºæ–‡ä»¶å¤¹è·¯å¾„
function createFilePath(fileName) {
    return `${TARGET_FOLDER}/${fileName}`;
}

// è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è·å–æˆ–åˆ›å»ºæ–‡ä»¶åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
async function safeCreateFile(fileName, content) {
    const filePath = createFilePath(fileName);
    
    try {
        // ç¡®ä¿ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
        const folder = app.vault.getAbstractFileByPath(TARGET_FOLDER);
        if (!folder) {
            await app.vault.createFolder(TARGET_FOLDER);
        }
        
        const targetFile = app.vault.getAbstractFileByPath(filePath);
        if (targetFile) {
            await app.vault.modify(targetFile, content);
            return 'updated';
        } else {
            await app.vault.create(filePath, content);
            return 'created';
        }
    } catch (error) {
        console.error(`ä¿å­˜æ–‡ä»¶ ${filePath} æ—¶å‡ºé”™:`, error);
        return 'failed';
    }
}

// ç”Ÿæˆæ€»è§ˆæ–‡ä»¶å†…å®¹
let overviewContent = `# å…¨ç«™æ ‡ç­¾æ€»è§ˆ\n\n`;
overviewContent += `ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}  |  æ‰«ææ–‡ä»¶ï¼š${totalFilesScanned}  |  å‘ç°æ ‡ç­¾ï¼š${allTags.size}\n\n`;
overviewContent += `---\n\n`;

// æ ‡ç­¾ç»Ÿè®¡è¡¨æ ¼
overviewContent += `## æ ‡ç­¾ç»Ÿè®¡\n\n`;
overviewContent += `| æ ‡ç­¾ | å†…å®¹æ•°é‡ | æ¶‰åŠæ–‡ä»¶ | æŸ¥çœ‹æ”¶é›† |\n`;
overviewContent += `|------|----------|----------|----------|\n`;

// ä¸ºæ¯ä¸ªæ ‡ç­¾ç”Ÿæˆæ–‡ä»¶
for (const tag of allTagsArray) {
    const sentences = tagSentencesMap.get(tag) || new Map();
    const filesForTag = tagFileMap.get(tag) || new Set();
    
    // å¦‚æœè¿™ä¸ªæ ‡ç­¾æ²¡æœ‰å®é™…å†…å®¹ï¼Œè·³è¿‡ç”Ÿæˆæ–‡ä»¶
    if (sentences.size === 0) {
        continue;
    }
    
    // ç”Ÿæˆå•ä¸ªæ ‡ç­¾æ”¶é›†æ–‡ä»¶
    const tagName = tag.replace('#', '');
    const safeFileName = sanitizeFileName(`${tagName}å†…å®¹æ”¶é›†.md`);
    const fileTitle = `${COLLECTION_TITLE_PREFIX}${tagName}`;
    
    let tagContent = `# ${fileTitle}\n\n`;
    tagContent += `æ”¶é›†æ—¶é—´ï¼š${new Date().toLocaleString()}  |  æ ‡ç­¾ï¼š${tag}  |  æ¶‰åŠæ–‡ä»¶ï¼š${filesForTag.size}  |  æ”¶é›†å†…å®¹ï¼š${sentences.size}\n\n`;
    tagContent += `---\n\n`;
    
    // å†…å®¹åˆ—è¡¨
    const sortedSentences = Array.from(sentences.entries())
        .sort(([sentenceA], [sentenceB]) => sentenceA.localeCompare(sentenceB));
    
    for (const [sentence, info] of sortedSentences) {
        tagContent += `${sentence}\n\n`;
        tagContent += `â†³ æ¥æºï¼š[[${info.sourceFile}]]\n\n`;
        tagContent += `---\n\n`;
    }
    
    tagContent += `*è‡ªåŠ¨ç”Ÿæˆ Â· æœ€åæ›´æ–°ï¼š${new Date().toLocaleString()} Â· æ ‡ç­¾ï¼š${tag}*\n`;
    tagContent += `*è¿”å› [[å…¨ç«™æ ‡ç­¾æ€»è§ˆ]]*`;
    
    // ä¿å­˜æ–‡ä»¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹
    const result = await safeCreateFile(safeFileName, tagContent);
    
    if (result === 'created') {
        createdFiles++;
    } else if (result === 'updated') {
        updatedFiles++;
    } else {
        failedFiles++;
        console.log(`æ ‡ç­¾ "${tag}" ä¿å­˜å¤±è´¥`);
    }
    
    // æ·»åŠ åˆ°æ€»è§ˆ
    overviewContent += `| ${tag} | ${sentences.size} | ${filesForTag.size} | [[${tagName}å†…å®¹æ”¶é›†]] |\n`;
}

// å®Œæˆæ€»è§ˆæ–‡ä»¶
overviewContent += `\n---\n\n`;
overviewContent += `## ç»Ÿè®¡ä¿¡æ¯\n`;
overviewContent += `- æ€»æ‰«ææ–‡ä»¶æ•°ï¼š${totalFilesScanned}\n`;
overviewContent += `- å‘ç°çš„æ ‡ç­¾æ•°ï¼š${allTagsArray.length}\n`;
overviewContent += `- æœ‰æ•ˆæ ‡ç­¾æ•°ï¼ˆæœ‰å†…å®¹ï¼‰ï¼š${createdFiles + updatedFiles}\n`;
overviewContent += `- æ–°åˆ›å»ºæ–‡ä»¶ï¼š${createdFiles}\n`;
overviewContent += `- æ›´æ–°æ–‡ä»¶ï¼š${updatedFiles}\n`;
overviewContent += `- å¤±è´¥æ–‡ä»¶ï¼š${failedFiles}\n`;
overviewContent += `- è¿è¡Œè€—æ—¶ï¼š${((new Date() - startTime) / 1000).toFixed(2)}ç§’\n\n`;

overviewContent += `## ä½¿ç”¨è¯´æ˜\n\n`;
overviewContent += `1. æœ¬æ–‡ä»¶ç”± **å…¨ç«™æ ‡ç­¾è‡ªåŠ¨æ”¶é›†å™¨** ç”Ÿæˆ\n`;
overviewContent += `2. ç‚¹å‡»è¡¨æ ¼ä¸­çš„é“¾æ¥æŸ¥çœ‹æ¯ä¸ªæ ‡ç­¾çš„å…·ä½“å†…å®¹\n`;
overviewContent += `3. æ ‡ç­¾æŒ‰å­—æ¯é¡ºåºæ’åº\n`;
overviewContent += `4. åªç”Ÿæˆæœ‰å®é™…å†…å®¹çš„æ ‡ç­¾æ”¶é›†æ–‡ä»¶\n\n`;

overviewContent += `*æœ€åæ›´æ–°ï¼š${new Date().toLocaleString()}*`;

// ä¿å­˜æ€»è§ˆæ–‡ä»¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹
const overviewResult = await safeCreateFile("å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md", overviewContent);

// ğŸŠ ç»“æœæ˜¾ç¤º
const runTime = ((new Date() - startTime) / 1000).toFixed(2);

tR += `# ğŸ¯ å…¨ç«™æ ‡ç­¾è‡ªåŠ¨æ”¶é›†å®Œæˆï¼\n\n`;

tR += `## ğŸ“Š æ‰§è¡Œç»Ÿè®¡\n\n`;
tR += `- **æ‰«ææ–‡ä»¶**ï¼š${totalFilesScanned} ä¸ªï¼ˆå·²æ’é™¤æ”¶é›†æ–‡ä»¶ï¼‰\n`;
tR += `- **å‘ç°æ ‡ç­¾**ï¼š${allTagsArray.length} ä¸ª\n`;
tR += `- **æœ‰æ•ˆæ ‡ç­¾**ï¼š${createdFiles + updatedFiles} ä¸ªï¼ˆæœ‰å®é™…å†…å®¹ï¼‰\n`;
tR += `- **æ–°åˆ›æ–‡ä»¶**ï¼š${createdFiles} ä¸ª\n`;
tR += `- **æ›´æ–°æ–‡ä»¶**ï¼š${updatedFiles} ä¸ª\n`;
tR += `- **å¤±è´¥æ–‡ä»¶**ï¼š${failedFiles} ä¸ª\n`;
tR += `- **è¿è¡Œè€—æ—¶**ï¼š${runTime} ç§’\n`;
tR += `- **ä¿å­˜ä½ç½®**ï¼š[[${TARGET_FOLDER}]] æ–‡ä»¶å¤¹\n\n`;

if (failedFiles > 0) {
    tR += `> âš ï¸ **æ³¨æ„**ï¼šæœ‰ ${failedFiles} ä¸ªæ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ–‡ä»¶ååŒ…å«ç‰¹æ®Šå­—ç¬¦ã€‚\n\n`;
}

tR += `## ğŸ·ï¸ å‘ç°çš„æ ‡ç­¾ï¼ˆå‰20ä¸ªï¼‰\n\n`;
const previewTags = allTagsArray.slice(0, 20);
previewTags.forEach(tag => {
    const sentences = tagSentencesMap.get(tag);
    const count = sentences ? sentences.size : 0;
    tR += `- ${tag} (${count}æ¡å†…å®¹)\n`;
});

if (allTagsArray.length > 20) {
    tR += `\n...ç­‰ ${allTagsArray.length} ä¸ªæ ‡ç­¾\n`;
}

tR += `\n## ğŸ“ ç”Ÿæˆæ–‡ä»¶\n\n`;
tR += `1. **[[${TARGET_FOLDER}/å…¨ç«™æ ‡ç­¾æ€»è§ˆ]]** - åŒ…å«æ‰€æœ‰æ ‡ç­¾çš„ç´¢å¼•è¡¨æ ¼\n`;
tR += `2. **æ ‡ç­¾æ”¶é›†æ–‡ä»¶** - æ¯ä¸ªæœ‰æ•ˆæ ‡ç­¾ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶ï¼ˆå…± ${createdFiles + updatedFiles} ä¸ªï¼‰\n`;
tR += `3. **å­˜å‚¨ä½ç½®**ï¼šæ‰€æœ‰æ–‡ä»¶å·²ä¿å­˜åˆ° **${TARGET_FOLDER}** æ–‡ä»¶å¤¹\n\n`;

// æ˜¾ç¤ºå‰3ä¸ªæœ‰å†…å®¹çš„æ ‡ç­¾
const previewTagsWithContent = allTagsArray.filter(tag => {
    const sentences = tagSentencesMap.get(tag);
    return sentences && sentences.size > 0;
}).slice(0, 3);

if (previewTagsWithContent.length > 0) {
    tR += `## ğŸ” æ ‡ç­¾å†…å®¹ç¤ºä¾‹\n\n`;
    
    for (const tag of previewTagsWithContent) {
        const sentences = tagSentencesMap.get(tag);
        const previewSentences = Array.from(sentences.keys()).slice(0, 1);
        
        tR += `### ${tag}\n`;
        previewSentences.forEach(sentence => {
            tR += `> ${sentence}\n\n`;
        });
        const tagName = tag.replace('#', '');
        tR += `[[${TARGET_FOLDER}/${sanitizeFileName(`${tagName}å†…å®¹æ”¶é›†`)}]] | `;
    }
}

tR += `\n\n---\n\n`;
tR += `## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ\n\n`;
tR += `1. æŸ¥çœ‹ **[[${TARGET_FOLDER}/å…¨ç«™æ ‡ç­¾æ€»è§ˆ]]** è·å–å®Œæ•´æ ‡ç­¾åˆ—è¡¨\n`;
tR += `2. ç‚¹å‡»ä»»æ„æ ‡ç­¾é“¾æ¥æŸ¥çœ‹è¯¦ç»†å†…å®¹æ”¶é›†\n`;
tR += `3. æ‰€æœ‰æ–‡ä»¶å·²ä¿å­˜åˆ°ï¼š**${TARGET_FOLDER}** æ–‡ä»¶å¤¹\n`;
tR += `4. å¦‚éœ€é‡æ–°ç”Ÿæˆï¼Œè¯·å†æ¬¡è¿è¡Œæ­¤æ¨¡æ¿\n\n`;

tR += `> âœ… **æ™ºèƒ½æ’é™¤**ï¼šæ¨¡æ¿å·²è‡ªåŠ¨æ’é™¤æ‰€æœ‰æ”¶é›†æ–‡ä»¶å’Œæ¨¡æ¿è‡ªèº«ï¼Œé¿å…é‡å¤æŸ¥è¯¢\n`;
tR += `> ğŸ“… **æœ€åè¿è¡Œ**ï¼š${new Date().toLocaleString()}\n`;
%>