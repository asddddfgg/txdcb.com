<%*
// ==========================================
// ğŸš€ V5 - æœ€ç»ˆç¨³å®šä¸å®¹é”™å¢å¼ºç‰ˆ
// æ ¸å¿ƒä¿®å¤ï¼š1. è§£å†³ [^\s æ–‡ä»¶åé”™è¯¯ã€‚ 2. è§£å†³ boolean true is not a function æ¨¡æ¿è§£æé”™è¯¯ã€‚
// ==========================================

// ğŸ¨ é…ç½®åŒºåŸŸï¼ˆä¿æŒä¸å˜ï¼‰
const TARGET_FOLDER = "02 Notes"; 
const COLLECTION_TITLE_PREFIX = "æ ‡ç­¾æ”¶é›†ï¼š"; 
const QUERY_TIME_LABEL = "æŸ¥è¯¢æ—¶é—´"; 
const CONTENT_HEADER_PREFIX = "å…³äº"; 
const CONTENT_HEADER_SUFFIX = "çš„åè¨€é‡‘å¥"; 
const SOURCE_NOTE_EMOJI = "ğŸ’¡"; 

// ğŸš« æ’é™¤çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰
const EXCLUDE_FILES = [
    "ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨.md",
    "å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md"
];
const currentTemplateName = app.workspace.activeLeaf?.view?.file?.name || "æœªçŸ¥æ¨¡æ¿";
if (!EXCLUDE_FILES.includes(currentTemplateName)) {
    EXCLUDE_FILES.push(currentTemplateName);
}

// è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆ SEO å‹å¥½çš„ Description (130å­—å·¦å³)
function generateSeoDescription(tag, sentences) {
    const tagName = tag.replace('#', '');
    let description = `æœ¬é¡µé¢æ”¶é›†äº†å…³äºã€Œ${tagName}ã€ä¸»é¢˜çš„å…¨éƒ¨ç²¾é€‰åè¨€é‡‘å¥ã€æ€æƒ³ç¢ç‰‡å’Œæ·±åˆ»æ´å¯Ÿã€‚`;
    const firstThree = Array.from(sentences.keys()).slice(0, 3);
    if (firstThree.length > 0) {
        description += firstThree.map(s => s.substring(0, 50)).join('...').substring(0, 100);
    }
    description += `... (å…±${sentences.size}æ¡)ã€‚æ— è®ºæ‚¨æ˜¯åœ¨ç ”ç©¶${tagName}è¿˜æ˜¯å¯»æ±‚çµæ„Ÿï¼Œè¿™é‡Œéƒ½æ˜¯æ‚¨çš„ä¸€ç«™å¼çŸ¥è¯†åº“ã€‚`;
    return description.substring(0, 130) + '...';
}

// è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦ (å¢å¼ºå®¹é”™)
function sanitizeFileName(filename) {
    // å…è®¸ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
    // ç§»é™¤æ‰€æœ‰å…¶ä»–ç‰¹æ®Šå­—ç¬¦å’Œæ­£åˆ™è¡¨è¾¾å¼ç¬¦å·
    let cleaned = filename.replace(/[\\/*"<>:|?#[\]{}()^$+.]/g, '-'); 
    // ç§»é™¤è¿ç»­çš„è¿å­—ç¬¦
    cleaned = cleaned.replace(/-+/g, '-');
    return cleaned;
}

// è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨æ–‡ä»¶æ“ä½œ
async function safeCreateFile(fileName, content) {
    const filePath = `${TARGET_FOLDER}/${fileName}`;
    try {
        const folder = app.vault.getAbstractFileByPath(TARGET_FOLDER);
        if (!folder) { await app.vault.createFolder(TARGET_FOLDER); }
        const targetFile = app.vault.getAbstractFileByPath(filePath);
        if (targetFile) { await app.vault.modify(targetFile, content); return 'updated'; } 
        else { await app.vault.create(filePath, content); return 'created'; }
    } catch (error) {
        console.error(`ä¿å­˜æ–‡ä»¶ ${filePath} æ—¶å‡ºé”™:`, error);
        return 'failed';
    }
}

// ğŸ•’ è®°å½•å¼€å§‹æ—¶é—´
const startTime = new Date();

// ğŸ” ç¬¬ä¸€æ­¥ï¼šæ‰«æå…¨ç«™æ‰€æœ‰æ ‡ç­¾
console.log("å¼€å§‹æ‰«æå…¨ç«™æ ‡ç­¾...");

// è·å–æ‰€æœ‰æ–‡ä»¶ï¼Œæ’é™¤æ”¶é›†æ–‡ä»¶å’ŒæŒ‡å®šæ’é™¤æ–‡ä»¶
const allFiles = app.vault.getMarkdownFiles()
    .filter(file => {
        if (EXCLUDE_FILES.includes(file.name) || 
            (file.name.includes(CONTENT_HEADER_SUFFIX) && file.path.includes(TARGET_FOLDER)) ||
            (file.name === "å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md" && file.path.includes(TARGET_FOLDER)) ||
            file.path.toLowerCase().includes('templates')
            ) {
            return false;
        }
        return true;
    });

let allTags = new Set();
let tagFileMap = new Map();
let totalFilesScanned = 0;
let tagSentencesMap = new Map(); 

// ğŸ“– æ‰«ææ‰€æœ‰æ–‡ä»¶ï¼Œæå–æ ‡ç­¾å’Œå¥å­ (å®Œæ•´ V3 é€»è¾‘å›æ”¾)
for (const file of allFiles) {
    totalFilesScanned++;
    const content = await app.vault.read(file);
    const lines = content.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (!line || line.length < 10) continue;
        if (line.match(/^---/) || line.match(/^\s*```/)) continue; 
        
        // ä¸¥æ ¼çš„æ ‡ç­¾åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼š# åè·Ÿè‡³å°‘ä¸€ä¸ªå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦æˆ–ä¸­æ–‡
        const tagMatches = line.match(/#[a-zA-Z0-9_\u4e00-\u9fa5][a-zA-Z0-9\/\-_\u4e00-\u9fa5]*/g);
        
        if (tagMatches) {
            const cleanTagsInLine = tagMatches.map(tag => tag.trim());
            
            let cleanSentence = line.replace(/^[>-]\s*/, '').replace(/\s+/g, ' ').replace(/`/g, '').trim();
            
            // è¿›ä¸€æ­¥è¿‡æ»¤æ— æ•ˆå¥å­
            if (cleanSentence.length >= 10 && 
                !cleanSentence.startsWith('//') &&
                !cleanSentence.includes('const ') &&
                !cleanSentence.includes('let ') &&
                !cleanSentence.includes('await ')) {

                cleanTagsInLine.forEach(tag => {
                    
                    const tagName = tag.substring(1); 
                    
                    if (tagName.length > 1 &&
                        !tag.match(/^#[0-9]/) && 
                        !tag.includes('SEARCH_TAG') &&
                        // æ’é™¤ CSS é¢œè‰²å€¼ (#f0f0f0 æˆ– #fff)
                        !/^#[0-9a-fA-F]{3,6}$/.test(tag) && 
                        // æ’é™¤è·¯å¾„/ä»£ç /ç‰¹æ®Šç¬¦å·æ ‡ç­¾
                        !tag.includes('//') && 
                        !tag.includes('[') && 
                        !tag.includes(']')) {
                        
                        allTags.add(tag);
                        
                        if (!tagSentencesMap.has(tag)) {
                            tagSentencesMap.set(tag, new Map());
                        }
                        
                        if (!tagSentencesMap.get(tag).has(cleanSentence)) {
                            tagSentencesMap.get(tag).set(cleanSentence, {
                                sourceFile: file.basename,
                                allTagsInLine: cleanTagsInLine 
                            });
                        }
                    }
                });
            }
        }
    }
}

// ğŸ“Š ç¬¬äºŒæ­¥ï¼šç”Ÿæˆæ”¶é›†æ–‡ä»¶
console.log(`å‘ç° ${allTags.size} ä¸ªæ ‡ç­¾ï¼Œå¼€å§‹ç”Ÿæˆæ”¶é›†æ–‡ä»¶åˆ° ${TARGET_FOLDER} æ–‡ä»¶å¤¹...`);

let createdFiles = 0;
let updatedFiles = 0;
let failedFiles = 0;
const allTagsArray = Array.from(allTags).sort();

// ä¸ºæ¯ä¸ªæ ‡ç­¾ç”Ÿæˆæ–‡ä»¶
for (const tag of allTagsArray) {
    const sentences = tagSentencesMap.get(tag) || new Map();
    const filesForTag = tagFileMap.get(tag) || new Set();
    
    if (sentences.size === 0) continue;
    
    const tagName = tag.replace('#', '');
    
    // **ğŸŒŸ å…³é”®ä¿®å¤ç‚¹ï¼šç”Ÿæˆæ–‡ä»¶åæ—¶ï¼Œå†æ¬¡ä½¿ç”¨ sanitizeFileNameï¼Œç¡®ä¿è·¯å¾„å®‰å…¨**
    const safeTagName = sanitizeFileName(tagName); 
    const safeFileName = `${safeTagName}${CONTENT_HEADER_SUFFIX}.md`; 
    const fileTitle = `${safeTagName}${CONTENT_HEADER_SUFFIX}`; 
    const seoDescription = generateSeoDescription(tag, sentences);
    
    // --- YAML Frontmatter ---
    let tagContent = `---
title: ${fileTitle}
description: ${seoDescription}
date: ${new Date().toISOString()}
tags: [æ ‡ç­¾æ”¶é›†, ${safeTagName}]
---
`;

    // --- æ­£æ–‡å¤´éƒ¨ä¿¡æ¯ ---
    tagContent += `# ${COLLECTION_TITLE_PREFIX}${tagName}\n\n`; // æ ‡é¢˜ H1 ä»ä½¿ç”¨åŸå§‹æ ‡ç­¾å
    tagContent += `ğŸ“… **${QUERY_TIME_LABEL}**ï¼š${new Date().toLocaleString()}\n`;
    tagContent += `ğŸ·ï¸ **æ ‡ç­¾**ï¼š${tag}\n`;
    tagContent += `ğŸ“ **æ¶‰åŠæ–‡ä»¶**ï¼š${filesForTag.size} ä»½\n`;
    tagContent += `ğŸ’¬ **æ”¶é›†å†…å®¹**ï¼š${sentences.size} æ¡\n\n`;
    tagContent += `---\n\n`;
    tagContent += `## ${CONTENT_HEADER_PREFIX}${tagName}${CONTENT_HEADER_SUFFIX}\n\n`; 
    
    const sortedSentences = Array.from(sentences.entries())
        .sort(([sentenceA], [sentenceB]) => sentenceA.localeCompare(sentenceB));
    
    // äºŒã€æ ¸å¿ƒè¾“å‡ºå†…å®¹ï¼šçº¯ HTML ç»“æ„åŒ–å¡ç‰‡ (V4 ç¨³å®šç»“æ„)
    for (const [sentence, info] of sortedSentences) {
        
        const tagsForDataAttribute = info.allTagsInLine
            .map(t => t.replace('#', '')) 
            .join(' ');
            
        const displayTags = info.allTagsInLine
            .map(t => `<span class="card-tag">${t}</span>`) 
            .join(' ');
            
        tagContent += `<article class="thought-card" data-tags="${tagsForDataAttribute}">\n`;
        tagContent += `  <p class="card-content">${sentence}</p>\n`;
        tagContent += `  <div class="card-meta">\n`;
        tagContent += `    ${SOURCE_NOTE_EMOJI} **æ¥æº**ï¼š[[${info.sourceFile}]]\n`;
        tagContent += `    <div class="card-tags">\n`;
        tagContent += `      ${displayTags}\n`;
        tagContent += `    </div>\n`;
        tagContent += `  </div>\n`;
        tagContent += `</article>\n\n`;
    }
    
    // åº•éƒ¨ä¿¡æ¯
    tagContent += `---\n\n`;
    tagContent += `*âœ… **è‡ªåŠ¨ç”Ÿæˆ** Â· **æœ€åæ›´æ–°**ï¼š${new Date().toLocaleString()} Â· **æ ‡ç­¾**ï¼š${tag}*\n`;
    tagContent += `*â¬†ï¸ **è¿”å›** [[å…¨ç«™æ ‡ç­¾æ€»è§ˆ]]*\n`;
    
    // ä¿å­˜æ–‡ä»¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹
    const result = await safeCreateFile(safeFileName, tagContent);
    
    if (result === 'created') { createdFiles++; } 
    else if (result === 'updated') { updatedFiles++; } 
    else { failedFiles++; }
}


// ğŸ“Š ç¬¬ä¸‰æ­¥ï¼šä¿å­˜æ€»è§ˆæ–‡ä»¶
let overviewContent = `# å…¨ç«™æ ‡ç­¾æ€»è§ˆ\n\n`;
overviewContent += `ğŸ“… **ç”Ÿæˆæ—¶é—´**ï¼š${new Date().toLocaleString()}\n`;
overviewContent += `ğŸ” **æ‰«ææ–‡ä»¶**ï¼š${totalFilesScanned} ä»½\n`;
overviewContent += `ğŸ·ï¸ **å‘ç°æ ‡ç­¾**ï¼š${allTags.size} ä¸ª\n\n`;
overviewContent += `---\n\n`;
overviewContent += `## æ ‡ç­¾ç»Ÿè®¡\n\n`;
overviewContent += `| æ ‡ç­¾ | å†…å®¹æ•°é‡ | æ¶‰åŠæ–‡ä»¶ | æŸ¥çœ‹æ”¶é›† |\n`;
overviewContent += `|:-----|:--------:|:--------:|:---------|\n`;
allTagsArray.forEach(tag => {
    const sentences = tagSentencesMap.get(tag) || new Map();
    const filesForTag = tagFileMap.get(tag) || new Set();
    if (sentences.size > 0) {
        const safeTagName = sanitizeFileName(tag.replace('#', ''));
        overviewContent += `| ${tag} | ${sentences.size} | ${filesForTag.size} | [[${safeTagName}${CONTENT_HEADER_SUFFIX}]] |\n`;
    }
});
overviewContent += `\n*æœ€åæ›´æ–°ï¼š${new Date().toLocaleString()}*`;
await safeCreateFile("å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md", overviewContent);


// ğŸŠ ç»“æœæ˜¾ç¤º
const runTime = ((new Date() - startTime) / 1000).toFixed(2);
tR += `# âœ… ğŸ¯ å…¨ç«™æ ‡ç­¾è‡ªåŠ¨æ”¶é›†å®Œæˆï¼(ç¨³å®šè¿è¡Œ)\n\n`;
tR += `## ğŸš€ æ ¸å¿ƒæ›´æ–°ï¼šç¨³å®šæ€§å¢å¼º\n\n`;
tR += `> [!success] **æ–‡ä»¶åˆ›å»ºå’Œæ¨¡æ¿è§£æé”™è¯¯å·²è§£å†³**\n`;
tR += `> 1. **æ–‡ä»¶åå®¹é”™**ï¼šæ–‡ä»¶åç”Ÿæˆæ—¶å·²å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œç¡®ä¿ä¸ä¼šå‡ºç° \`[^\s\` ç­‰éæ³•æ–‡ä»¶åã€‚\n`;
tR += `> 2. **æ¨¡æ¿è§£æ**ï¼šå·²å°†å®Œæ•´çš„æ‰«æé€»è¾‘å’Œå¼‚æ­¥å¤„ç†æµç¨‹æ•´åˆï¼Œè§£å†³äº† \`boolean true is not a function\` é”™è¯¯ã€‚\n\n`;
tR += `## ğŸ“Š æ‰§è¡Œç»Ÿè®¡\n\n`;
tR += `| æŒ‡æ ‡ | æ•°é‡ |\n`;
tR += `|:---|:---:|\n`;
tR += `| æ‰«ææ–‡ä»¶ | ${totalFilesScanned} |\n`;
tR += `| **æœ‰æ•ˆæ ‡ç­¾** | **${createdFiles + updatedFiles}** |\n`;
tR += `| æ€»è€—æ—¶ | ${runTime} ç§’ |\n\n`;

tR += `> ğŸ“… **æœ€åè¿è¡Œ**ï¼š${new Date().toLocaleString()}\n`;
%>