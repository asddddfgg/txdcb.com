<%*
// ğŸš€ SEOæ™ºèƒ½æ ‡ç­¾æ”¶é›†å™¨ - æ ·å¼ä¸é€»è¾‘åˆ†ç¦»ç‰ˆ

if (typeof window._tagCollectorRunning !== 'undefined') {
    tR += "# âš ï¸ æ£€æµ‹åˆ°é‡å¤æ‰§è¡Œï¼Œå·²åœæ­¢\n\n> ä¸Šæ¬¡è¿è¡Œå°šæœªå®Œæˆï¼Œè¯·ç¨åå†è¯•";
    return;
}
window._tagCollectorRunning = true;

const cleanup = () => setTimeout(() => { delete window._tagCollectorRunning; }, 1000);

try {
    const TARGET_FOLDER = "02 Notes"; 
    const HEADER_SUFFIX = "çš„åè¨€é‡‘å¥"; 
    const EXCLUDE_FOLDERS = ["Templaters", "04 Private ç§äººæ–‡ä»¶å¤¹", "templates"];
    const EXCLUDE_FILES = new Set(["ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨.md","å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md","tR.md"]);
    const startTime = Date.now();
    const currentFile = app.workspace.activeLeaf?.view?.file?.name;
    if (currentFile) EXCLUDE_FILES.add(currentFile);

    // æ‰«ææ–‡ä»¶
    const allFiles = app.vault.getMarkdownFiles().filter(file => {
        const path = file.path;
        if (EXCLUDE_FILES.has(file.name)) return false;
        if (EXCLUDE_FOLDERS.some(f => path.includes(f))) return false;
        return true;
    });

    let allTags = new Set();
    let tagContentMap = new Map();

    for (const file of allFiles) {
        try {
            const content = await app.vault.read(file);
            const lines = content.split('\n');
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.length < 10 || trimmed.startsWith('```') || trimmed.startsWith('---')) continue;
                const tagMatches = trimmed.match(/#[\w\u4e00-\u9fa5\/\-]+/g);
                if (!tagMatches) continue;

                const cleanSentence = trimmed.replace(/#[\w\u4e00-\u9fa5\/\-]+/g,'').replace(/\s+/g,' ').trim();
                if (cleanSentence.length < 10) continue;

                tagMatches.forEach(tag => {
                    const t = tag.substring(1);
                    allTags.add(t);
                    if (!tagContentMap.has(t)) tagContentMap.set(t, []);
                    const existing = tagContentMap.get(t);
                    if (!existing.some(e => e.sentence === cleanSentence)) {
                        existing.push({ sentence: cleanSentence, sourceFile: file.basename, allTags: tagMatches.map(tt=>tt.substring(1)) });
                    }
                });
            }
        } catch(e){ console.warn(file.name,e); }
    }

    // ç¡®ä¿ç›®å½•å­˜åœ¨
    if (!app.vault.getAbstractFileByPath(TARGET_FOLDER)) await app.vault.createFolder(TARGET_FOLDER);

    // ç”Ÿæˆæ¯ä¸ªæ ‡ç­¾æ–‡ä»¶
    for (const tag of Array.from(allTags).sort()) {
        const contents = tagContentMap.get(tag);
        if (!contents || !contents.length) continue;
        const fileName = `${tag}${HEADER_SUFFIX}.md`;
        const filePath = `${TARGET_FOLDER}/${fileName}`;
        const existingFile = app.vault.getAbstractFileByPath(filePath);

        // front matter ä¿ç•™åŸé€»è¾‘
        let frontMatter = `---
seo_title: "${tag}çš„åè¨€é‡‘å¥"
quote_count: ${contents.length}
primary_tag: "${tag}"
---
`;

        // HTML ä¸»ä½“ï¼ˆclass è°ƒç”¨ SCSSï¼‰
        let htmlContent = frontMatter + `
<div class="tag-page" data-tag="${tag}">
    <div class="tag-page-header">
        <h1>å…³äºã€Œ${tag}ã€çš„åè¨€é‡‘å¥</h1>
        <p>æ”¶å½• ${contents.length} æ¡å†…å®¹ Â· æ¥è‡ª ${new Set(contents.map(c=>c.sourceFile)).size} ä»½ç¬”è®°</p>
    </div>
    <div class="tag-page-content">
`;

        contents.sort((a,b)=>a.sentence.localeCompare(b.sentence));
        for (const item of contents) {
            const tagLinks = item.allTags.map(t => `<a href="obsidian://open?vault=${encodeURIComponent(app.vault.getName())}&file=${encodeURIComponent(t + HEADER_SUFFIX)}">${t}</a>`).join('');
            htmlContent += `
        <article class="tag-card">
            <div class="sentence">${item.sentence}</div>
            <div class="tags">${tagLinks}</div>
        </article>`;
        }

        htmlContent += `
    </div>
    <div class="tag-page-footer">
        <p>ğŸ• ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
        <a href="obsidian://open?vault=${encodeURIComponent(app.vault.getName())}&file=${encodeURIComponent(TARGET_FOLDER + '/å…¨ç«™æ ‡ç­¾æ€»è§ˆ')}">è¿”å›æ€»è§ˆ</a>
    </div>
</div>`;

        if (existingFile) await app.vault.modify(existingFile, htmlContent);
        else await app.vault.create(filePath, htmlContent);
    }

} catch(e){ console.error("æ¨¡æ¿æ‰§è¡Œå‡ºé”™", e); tR += `# âŒ ${e.message}`; }
finally{ cleanup(); }
%>
