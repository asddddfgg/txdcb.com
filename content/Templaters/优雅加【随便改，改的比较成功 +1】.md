<%*
// ==========================================
// ğŸš€ FIXED - ä¿®å¤ç‰ˆæç®€æ ‡ç­¾æ”¶é›†å™¨ (å·²ä¿®æ­£è¯­æ³•é”™è¯¯å’Œé“¾æ¥é—®é¢˜)
// ä¿®å¤ï¼š1. startTimeå˜é‡å®šä¹‰ 2. æ–‡ä»¶é“¾æ¥æ­£ç¡®æ€§ 3. Dataviewå†²çª
// ==========================================

// ç«‹å³è®¾ç½®ä¸€ä¸ªæ‰§è¡Œé”ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
if (typeof window._tagCollectorRunning !== 'undefined') {
    tR += "# âš ï¸ æ£€æµ‹åˆ°é‡å¤æ‰§è¡Œï¼Œå·²åœæ­¢\n\n> ä¸Šæ¬¡è¿è¡Œå°šæœªå®Œæˆï¼Œè¯·ç¨åå†è¯•";
    return;
}
window._tagCollectorRunning = true;

// æ¸…ç†å‡½æ•°
const cleanup = () => {
    setTimeout(() => {
        delete window._tagCollectorRunning;
    }, 1000);
};

try {
    // ==========================================
    // ğŸ¨ é›†ä¸­é…ç½®åŒºåŸŸ - åœ¨è¿™é‡Œä¿®æ”¹é…ç½®å³å¯
    // ==========================================
    
    // ç›®æ ‡æ–‡ä»¶å¤¹
    const TARGET_FOLDER = "02 Notes"; 
    
    // æ–‡ä»¶ååç¼€
    const HEADER_SUFFIX = "çš„åè¨€é‡‘å¥"; 
    
    // æ¥æºå›¾æ ‡
    const SOURCE_ICON = "ğŸ“˜";
    
    // ğŸš« è¦æ’é™¤çš„æ–‡ä»¶å¤¹ï¼ˆåœ¨è¿™é‡Œæ·»åŠ æˆ–åˆ é™¤æ–‡ä»¶å¤¹ï¼‰
    const EXCLUDE_FOLDERS = [
        "Templaters",               // æ¨¡æ¿æ–‡ä»¶å¤¹
        "04 Private ç§äººæ–‡ä»¶å¤¹",     // ç§äººæ–‡ä»¶å¤¹
        "templates"                 // é€šç”¨æ¨¡æ¿æ–‡ä»¶å¤¹ï¼ˆå°å†™ï¼‰
    ];
    
    // ğŸš« è¦æ’é™¤çš„ç‰¹å®šæ–‡ä»¶
    const EXCLUDE_FILES = new Set([
        "ä¸‡èƒ½æ ‡ç­¾æœç´¢å™¨.md",
        "å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md",
        "tR.md"
    ]);
    
    // ğŸ”§ å…³é”®ä¿®å¤ï¼šå®šä¹‰startTimeå˜é‡
    const startTime = Date.now();
    
    // æ·»åŠ å½“å‰æ¨¡æ¿ååˆ°æ’é™¤åˆ—è¡¨
    const currentFile = app.workspace.activeLeaf?.view?.file?.name;
    if (currentFile) EXCLUDE_FILES.add(currentFile);

    // ğŸ¨ æç®€è‰²å½©ç³»ç»Ÿ
    const COLORS = {
        "èŒåœº": "#ff6b6b",
        "å“²å­¦": "#5f27cd", 
        "ç¤¾ä¼šè§‚å¯Ÿ": "#00b894",
        "ä¸ªäººæˆé•¿": "#fdcb6e",
        "çŠ€åˆ©åæ§½": "#fd79a8",
        "AI": "#3498db",
        "æ€è€ƒ": "#00cec9",
        "ç«äº‰å“²å­¦": "#8e44ad",
        "å¿ƒæ€è°ƒæ•´": "#16a085",
        "æˆåŠŸå­¦": "#e17055",
        "æƒåŠ›ç»“æ„": "#c0392b",
        "äººæ€§": "#27ae60"
    };

    function getColor(tag) {
        return COLORS[tag] || "#667eea";
    }

    // ğŸ” æ‰«æé€»è¾‘
    console.log("ğŸ”„ å¼€å§‹æ‰«ææ ‡ç­¾...");
    
    // è·å–æ‰€æœ‰æ–‡ä»¶ï¼Œæ’é™¤å·²ç”Ÿæˆçš„æ–‡ä»¶å’ŒæŒ‡å®šæ–‡ä»¶å¤¹
    const allFiles = app.vault.getMarkdownFiles().filter(file => {
        const name = file.name;
        const path = file.path;
        
        // 1. æ’é™¤ç‰¹å®šæ–‡ä»¶
        if (EXCLUDE_FILES.has(name)) return false;
        
        // 2. æ’é™¤å·²ç”Ÿæˆçš„æ”¶é›†æ–‡ä»¶
        if (name.includes(HEADER_SUFFIX) && path.includes(TARGET_FOLDER)) return false;
        
        // 3. æ’é™¤æ€»è§ˆæ–‡ä»¶
        if (name === "å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md" && path.includes(TARGET_FOLDER)) return false;
        
        // 4. æ’é™¤æŒ‡å®šçš„æ–‡ä»¶å¤¹ï¼ˆç°åœ¨åœ¨è¿™é‡Œç»Ÿä¸€å¤„ç†ï¼‰
        for (const folder of EXCLUDE_FOLDERS) {
            if (path.includes(folder)) return false;
        }
        
        return true;
    });

    console.log(`ğŸ“‚ æ‰¾åˆ° ${allFiles.length} ä¸ªå¾…æ‰«ææ–‡ä»¶`);

    // å­˜å‚¨æ•°æ®ç»“æ„
    let allTags = new Set();
    let tagContentMap = new Map(); // tag -> {sentence, sourceFile, otherTags}
    let totalFilesScanned = 0;

    // ğŸ“– æ‰«ææ–‡ä»¶å†…å®¹
    for (const file of allFiles) {
        totalFilesScanned++;
        try {
            const content = await app.vault.read(file);
            const lines = content.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.length < 10) continue;
                
                // è·³è¿‡ä»£ç å—å’Œfrontmatter
                if (line.startsWith('```') || line.startsWith('---')) continue;
                
                // æŸ¥æ‰¾æ ‡ç­¾
                const tagMatches = line.match(/#[a-zA-Z0-9_\u4e00-\u9fa5][a-zA-Z0-9\/\-_\u4e00-\u9fa5]*/g);
                if (!tagMatches) continue;
                
                // æ¸…ç†å¥å­
                let cleanSentence = line
                    .replace(/^[>-]\s*/, '')
                    .replace(/#[a-zA-Z0-9_\u4e00-\u9fa5][a-zA-Z0-9\/\-_\u4e00-\u9fa5]*/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                if (cleanSentence.length < 10) continue;
                
                // è¿‡æ»¤æœ‰æ•ˆæ ‡ç­¾
                const validTags = tagMatches.filter(tag => {
                    const tagName = tag.substring(1);
                    return tagName.length > 1 && 
                           !tag.match(/^#[0-9]/) &&
                           !/^#[0-9a-fA-F]{3,6}$/.test(tag);
                });
                
                if (validTags.length === 0) continue;
                
                // æ·»åŠ åˆ°æ•°æ®ç»“æ„
                validTags.forEach(tag => {
                    allTags.add(tag);
                    
                    if (!tagContentMap.has(tag)) {
                        tagContentMap.set(tag, []);
                    }
                    
                    // é¿å…é‡å¤å¥å­
                    const existing = tagContentMap.get(tag);
                    if (!existing.some(item => item.sentence === cleanSentence)) {
                        existing.push({
                            sentence: cleanSentence,
                            sourceFile: file.basename,
                            allTags: [...validTags]
                        });
                    }
                });
            }
        } catch (error) {
            console.warn(`âŒ è¯»å–æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™:`, error);
        }
    }

    console.log(`ğŸ·ï¸ å‘ç° ${allTags.size} ä¸ªæ ‡ç­¾`);

    // ğŸ“ ç¡®ä¿ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
    const folder = app.vault.getAbstractFileByPath(TARGET_FOLDER);
    if (!folder) {
        await app.vault.createFolder(TARGET_FOLDER);
        console.log(`ğŸ“ åˆ›å»ºæ–‡ä»¶å¤¹: ${TARGET_FOLDER}`);
    }

    // ğŸ“ ä¸ºæ¯ä¸ªæ ‡ç­¾ç”Ÿæˆæ–‡ä»¶
    const allTagsArray = Array.from(allTags).sort();
    let createdFiles = 0, updatedFiles = 0;

    for (const tag of allTagsArray) {
        const contents = tagContentMap.get(tag) || [];
        if (contents.length === 0) continue;
        
        const tagName = tag.replace('#', '');
        const color = getColor(tagName);
        const lightColor = color + '20'; // æ·»åŠ é€æ˜åº¦
        
        // ç”Ÿæˆæ–‡ä»¶å
        const fileName = `${tagName}${HEADER_SUFFIX}.md`;
        
        // ç»Ÿè®¡æ¶‰åŠçš„æ–‡ä»¶
        const sourceFiles = new Set(contents.map(c => c.sourceFile));
        
        // --- ç”Ÿæˆç®€æ´HTMLå†…å®¹ ---
        let htmlContent = `<div style="
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #1e293b;
            background: #f8fafc;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        ">`;
        
        // é¡¶éƒ¨æ ‡é¢˜
        htmlContent += `
        <div style="background: ${color}; padding: 3rem 1.5rem; text-align: center; color: white;">
            <h1 style="font-size: 2rem; font-weight: 700; margin: 0 0 0.5rem;">ã€Œ${tagName}ã€çš„åè¨€é‡‘å¥</h1>
            <p style="opacity: 0.9; margin: 0; font-size: 1rem;">æ”¶å½• ${contents.length} æ¡å†…å®¹ Â· æ¥è‡ª ${sourceFiles.size} ä»½ç¬”è®°</p>
        </div>`;
        
        // ä¸»å†…å®¹åŒº
        htmlContent += `
        <div style="max-width: 700px; margin: 0 auto; padding: 2rem 1.5rem;">
            <div style="display: grid; gap: 1.25rem;">`;
        
        // æŒ‰å¥å­æ’åº
        contents.sort((a, b) => a.sentence.localeCompare(b.sentence));
        
        // ç”Ÿæˆå¡ç‰‡
        for (const item of contents) {
            const firstTagName = item.allTags[0]?.replace('#', '') || tagName;
            const cardColor = getColor(firstTagName);
            
            // ç”Ÿæˆæ ‡ç­¾é“¾æ¥ - ç¡®ä¿æ¯ä¸ªæ ‡ç­¾éƒ½èƒ½æ­£ç¡®é“¾æ¥
            const tagLinks = item.allTags.map(t => {
                const tName = t.replace('#', '');
                const tColor = getColor(tName);
                return `<a href="obsidian://open?vault=${encodeURIComponent(app.vault.getName())}&file=${encodeURIComponent(tName + HEADER_SUFFIX)}"
                       style="
                           background: ${tColor}20;
                           color: ${tColor};
                           padding: 0.2rem 0.6rem;
                           border-radius: 12px;
                           margin-left: 0.25rem;
                           text-decoration: none;
                           font-weight: 500;
                       "
                       onmouseover="this.style.background='${tColor}'; this.style.color='white'"
                       onmouseout="this.style.background='${tColor}20'; this.style.color='${tColor}'">${t}</a>`;
            }).join('');
            
            htmlContent += `
            <div style="
                background: white;
                border-radius: 8px;
                padding: 1.5rem;
                border-left: 4px solid ${cardColor};
                box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            ">
                <div style="font-size: 1.05rem; line-height: 1.6; margin-bottom: 1rem;">
                    ${item.sentence}
                </div>
                <div style="
                    display: flex;
                    justify-content: flex-end;
                    align-items: center;
                    flex-wrap: wrap;
                    gap: 0.5rem;
                    font-size: 0.85rem;
                    color: #64748b;
                    margin-top: 1rem;
                ">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                        ${tagLinks}
                    </div>
                </div>
            </div>`;
        }
        
        // åº•éƒ¨
        htmlContent += `
            </div>
            <div style="margin-top: 3rem; padding: 1.5rem; background: white; border-radius: 8px; text-align: center;">
                <p style="color: #64748b; margin-bottom: 1rem;">
                    ğŸ• ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}
                </p>
                <a href="obsidian://open?vault=${encodeURIComponent(app.vault.getName())}&file=${encodeURIComponent(TARGET_FOLDER + '/å…¨ç«™æ ‡ç­¾æ€»è§ˆ')}"
                   style="
                       display: inline-block;
                       background: ${color};
                       color: white;
                       text-decoration: none;
                       padding: 0.5rem 1.25rem;
                       border-radius: 6px;
                       font-weight: 500;
                   ">è¿”å›æ€»è§ˆ</a>
            </div>
        </div>
        </div>`;
        
        // åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶
        const filePath = `${TARGET_FOLDER}/${fileName}`;
        const existingFile = app.vault.getAbstractFileByPath(filePath);
        
        try {
            if (existingFile) {
                await app.vault.modify(existingFile, htmlContent);
                updatedFiles++;
            } else {
                await app.vault.create(filePath, htmlContent);
                createdFiles++;
            }
        } catch (error) {
            console.error(`âŒ å¤„ç†æ–‡ä»¶ ${fileName} æ—¶å‡ºé”™:`, error);
        }
    }

    // ğŸ“Š ç”Ÿæˆæ€»è§ˆæ–‡ä»¶
    const overviewContent = `# ğŸ·ï¸ å…¨ç«™æ ‡ç­¾æ€»è§ˆ

## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯
- **æ‰«ææ–‡ä»¶**ï¼š${totalFilesScanned} ä»½
- **å‘ç°æ ‡ç­¾**ï¼š${allTags.size} ä¸ª
- **ç”Ÿæˆé¡µé¢**ï¼š${createdFiles + updatedFiles} ä¸ª
- **æ›´æ–°æ—¶é—´**ï¼š${new Date().toLocaleString()}

## ğŸ“‹ æ ‡ç­¾åˆ—è¡¨
${allTagsArray.map(tag => {
    const contents = tagContentMap.get(tag) || [];
    const sources = new Set(contents.map(c => c.sourceFile));
    const tagName = tag.replace('#', '');
    return `- **${tag}** (${contents.length}æ¡ï¼Œ${sources.size}ä¸ªæ–‡ä»¶) â†’ [[${tagName}${HEADER_SUFFIX}]]`;
}).join('\n')}

---

*æœ€åè¿è¡Œï¼š${new Date().toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit' })}*`;

    const overviewPath = `${TARGET_FOLDER}/å…¨ç«™æ ‡ç­¾æ€»è§ˆ.md`;
    const existingOverview = app.vault.getAbstractFileByPath(overviewPath);
    
    if (existingOverview) {
        await app.vault.modify(existingOverview, overviewContent);
    } else {
        await app.vault.create(overviewPath, overviewContent);
    }

    // ğŸŠ æ˜¾ç¤ºç»“æœ
    const runTime = ((Date.now() - startTime) / 1000).toFixed(1);
    tR += `# âœ… æ ‡ç­¾æ”¶é›†å®Œæˆï¼

## ğŸ“Š æ‰§è¡Œç»“æœ
- **æ‰«ææ–‡ä»¶**ï¼š${totalFilesScanned} ä»½
- **å‘ç°æ ‡ç­¾**ï¼š${allTags.size} ä¸ª
- **æ–°å»ºé¡µé¢**ï¼š${createdFiles} ä¸ª
- **æ›´æ–°é¡µé¢**ï¼š${updatedFiles} ä¸ª
- **å¤„ç†è€—æ—¶**ï¼š${runTime} ç§’

## ğŸ”— å¿«é€Ÿè®¿é—®
- [[å…¨ç«™æ ‡ç­¾æ€»è§ˆ]] - æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾ç»Ÿè®¡
- [[${TARGET_FOLDER}]] - è¿›å…¥ç”Ÿæˆç›®å½•

> ğŸ• è¿è¡Œæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}
> 
> ğŸ’¡ é…ç½®è¯´æ˜ï¼š
> 1. âœ… æ’é™¤æ–‡ä»¶å¤¹ï¼š${EXCLUDE_FOLDERS.join('ã€')}
> 2. âœ… æ‰€æœ‰æ–‡ä»¶é“¾æ¥éƒ½èƒ½æ­£ç¡®å·¥ä½œ
> 3. âœ… æ ‡ç­¾å’Œæ¥æºç‚¹å‡»åéƒ½èƒ½è·³è½¬åˆ°æ­£ç¡®æ–‡ä»¶
> 4. âœ… ä¸‹æ¬¡è¦æ’é™¤æ–°æ–‡ä»¶å¤¹ï¼Œåªéœ€åœ¨å¼€å¤´EXCLUDE_FOLDERSæ•°ç»„ä¸­æ·»åŠ 
`;

} catch (error) {
    console.error("âŒ æ¨¡æ¿æ‰§è¡Œå‡ºé”™:", error);
    tR += `# âŒ æ‰§è¡Œå‡ºé”™

é”™è¯¯ä¿¡æ¯ï¼š
\`\`\`
${error.message}
\`\`\`

é”™è¯¯ä½ç½®ï¼š${error.stack?.split('\n')[1] || 'æœªçŸ¥'}

è¯·æ£€æŸ¥ï¼š
1. ç¡®ä¿ Obsidian æ˜¯æœ€æ–°ç‰ˆæœ¬
2. ç¡®è®¤æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
3. é‡å¯ Obsidian åé‡è¯•
4. æ£€æŸ¥æ’ä»¶å†²çª
`;
} finally {
    // æ¸…ç†æ‰§è¡Œé”
    cleanup();
}
%>